{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="text-center">Lobby: Warten auf zweiten Spieler...</h4>
                </div>
                <div class="card-body">
                    <p><strong>Spielername:</strong> {{ user.username }}</p>
                    <p><strong>Fragenpool:</strong> {{ game.pool.name }}</p>

                    <div id="lobby-container"
                         hx-get="{% url 'multiplayer:mp_lobby_content' game_id=game.id %}"
                         hx-trigger="load, every 5s"
                         hx-swap="outerHTML">
                        <p><strong>Spieler 1:</strong> {{ game.player1.username }}</p>
                        <p><strong>Spieler 2:</strong>
                            {% if game.player2 %}
                                {{ game.player2.username }}
                            {% else %}
                                <em class="text-muted">Warten auf Spieler 2...</em>
                            {% endif %}
                        </p>
                    </div>

                    <div class="text-center mt-4">
                        <a href="{% url 'multiplayer:mp_overview' %}" class="btn btn-danger">
                            Lobby verlassen
                        </a>
                    </div>
                </div>
            </div>

            <!-- Dynamischer Status-Check-Container -->
            <div id="game-status-container"
                 hx-get="{% url 'multiplayer:check_game_status' game_id=game.id %}"
                 hx-trigger="load, every 2s"
                 hx-swap="none"
                 hx-on="htmx:afterRequest:checkRedirect">
            </div>
        </div>
    </div>
</div>

<script>
    // Überprüfung der Antwort und Weiterleitung
    function checkRedirect(event) {
        var responseText = event.detail.xhr.responseText;
        try {
            var jsonResponse = JSON.parse(responseText);
            if (jsonResponse.redirect_url) {
                window.location.href = jsonResponse.redirect_url;
            }
        } catch (e) {
            console.error("Fehler beim Verarbeiten der JSON-Antwort: ", e);
        }
    }

    // Manuelle HTMX Event Listener-Registrierung (Sicherheitshalber)
    document.addEventListener('htmx:afterRequest', function (event) {
        if (event.detail.target.id === 'game-status-container') {
            checkRedirect(event);
        }
    });
</script>
{% endblock %}











